<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL PRO - Sistema de Mantenimiento Predictivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- HEADER -->
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1>
                    <i class="fas fa-shield-halved"></i>
                    SENTINEL PRO
                </h1>
                <p>Sistema Inteligente de Mantenimiento Predictivo Vehicular</p>
            </div>
            <div id="obdStatusIndicator" class="status-indicator">
                <i class="fas fa-circle"></i>
                <span>Desconectado</span>
            </div>
        </div>
    </header>

    <!-- NAVBAR DE NAVEGACIÓN -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="fleet.html" class="nav-link">
                <i class="fas fa-cars"></i> Flotas
            </a>
            <a href="analytics.html" class="nav-link">
                <i class="fas fa-chart-line"></i> Analytics
            </a>
            <a href="vehicle-detail.html" class="nav-link" id="nav-vehicle-detail" style="display: none;">
                <i class="fas fa-car-side"></i> Vehículo
            </a>
            <a href="alerts.html" class="nav-link">
                <i class="fas fa-bell"></i> Alertas
            </a>
            <a href="import.html" class="nav-link" id="nav-import" style="display: none;">
                <i class="fas fa-file-import"></i> Importar CSV
            </a>
        </div>
    </nav>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container">

        <!-- SELECTOR DE MODO DE TRABAJO -->
        <div class="card" id="vehicleSelectorCard">
            <h2>
                <i class="fas fa-route"></i>
                Selecciona Modo de Trabajo
            </h2>

            <div class="mode-selector">
                <button class="mode-btn active" id="modeFleet" data-mode="fleet">
                    <i class="fas fa-cars"></i>
                    <span class="mode-title">Vehículo de Flota</span>
                    <span class="mode-desc">Selecciona un vehículo existente</span>
                </button>

                <button class="mode-btn" id="modeNew" data-mode="new">
                    <i class="fas fa-plus-circle"></i>
                    <span class="mode-title">Nuevo Vehículo</span>
                    <span class="mode-desc">Crear y configurar nuevo</span>
                </button>

                <button class="mode-btn" id="modeImport" data-mode="import">
                    <i class="fas fa-file-import"></i>
                    <span class="mode-title">Importar Datos CSV</span>
                    <span class="mode-desc">Subir viajes de otro dispositivo</span>
                </button>
            </div>

            <!-- Selector de vehículo de flota (visible solo en modo fleet) -->
            <div id="fleetVehicleSelector" class="vehicle-selector-container">
                <label for="fleetVehicleSelect">
                    <i class="fas fa-car"></i> Selecciona un vehículo de tu flota
                </label>
                <select id="fleetVehicleSelect" class="form-control">
                    <option value="">Cargando vehículos...</option>
                </select>
                <button id="loadFleetVehicle" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fas fa-check"></i> Cargar Vehículo
                </button>
            </div>

            <!-- Mensaje para modo nuevo (visible solo en modo new) -->
            <div id="newVehicleMessage" class="info-message" style="display: none;">
                <i class="fas fa-info-circle"></i>
                <p>Completa los datos del vehículo en la sección "Configuración del Vehículo" y haz clic en "Guardar Nuevo Vehículo".</p>
            </div>

            <!-- Uploader CSV (visible solo en modo import) -->
            <div id="csvImportSection" class="csv-import-container" style="display: none;">
                <div class="warning-message" id="csvWarningNoVehicle">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p><strong>¡Atención!</strong> Los archivos CSV contienen datos del motor pero no información del vehículo.</p>
                    <p>Debes configurar el vehículo en la sección "Configuración del Vehículo" antes de importar.</p>
                </div>
                <p class="info-text">
                    <i class="fas fa-info-circle"></i>
                    Sube archivos CSV de Torque, OBD11, Carista, VCDS u otros dispositivos de diagnóstico.
                </p>
                <div class="upload-zone" id="csvDropZone">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Arrastra archivos CSV aquí</p>
                    <p class="small-text">o haz clic para seleccionar</p>
                    <input type="file" id="csvImportInput" accept=".csv" multiple style="display: none;">
                </div>
                <button id="proceedToImport" class="btn btn-primary" style="margin-top: 1rem; display: none;">
                    <i class="fas fa-arrow-right"></i> Continuar a Importación
                </button>
            </div>
        </div>

        <!-- CONTROL DE VIAJE Y CONEXIÓN OBD -->
        <div class="card" id="tripControlCard">
            <h2>
                <i class="fas fa-route"></i>
                Control de Viaje
            </h2>

            <!-- Estado de conexión OBD -->
            <div class="connection-status">
                <div class="status-indicator disconnected" id="obdStatusIndicator">
                    <i class="fas fa-circle"></i>
                    <span id="obdStatusText">Adaptador OBD desconectado</span>
                </div>
                <small id="obdStatusDetail" class="status-detail">
                    Haz clic en "Conectar OBD" cuando el adaptador esté enchufado y el motor encendido
                </small>
            </div>

            <!-- Botones de control OBD (MODO MANUAL) -->
            <div class="obd-controls" style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button id="connectOBDBtn" class="btn btn-success">
                    <i class="fas fa-plug"></i>
                    Conectar OBD
                </button>
                <button id="disconnectOBDBtn" class="btn btn-secondary" style="display: none;">
                    <i class="fas fa-unlink"></i>
                    Desconectar OBD
                </button>
            </div>

            <!-- Selector de vehículo (SE MUESTRA cuando OBD conecta) -->
            <div id="tripVehicleSection" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Adaptador OBD conectado</strong>
                        <p>Selecciona el vehículo que estás conduciendo o crea uno nuevo:</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="tripVehicleSelect">
                        <i class="fas fa-car"></i> Vehículo conectado
                    </label>
                    <select id="tripVehicleSelect" class="form-control">
                        <option value="">Cargando vehículos...</option>
                    </select>
                </div>

                <div class="trip-vehicle-actions">
                    <button id="confirmVehicleBtn" class="btn btn-success" disabled>
                        <i class="fas fa-check-circle"></i>
                        Confirmar Vehículo
                    </button>

                    <button id="createNewVehicleBtn" class="btn btn-secondary">
                        <i class="fas fa-plus-circle"></i>
                        Crear Nuevo Vehículo
                    </button>
                </div>
            </div>

            <!-- Tarjeta de vehículo conectado (SE MUESTRA después de confirmar) -->
            <div id="connectedVehicleCard" style="display: none;">
                <div class="vehicle-card-connected">
                    <div class="vehicle-card-image">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="vehicle-card-info">
                        <h3 id="connectedVehicleName">-</h3>
                        <div class="vehicle-card-specs">
                            <span id="connectedVehicleYear">-</span>
                            <span>•</span>
                            <span id="connectedVehicleFuel">-</span>
                            <span>•</span>
                            <span id="connectedVehicleTransmission">-</span>
                        </div>
                        <div class="vehicle-card-details">
                            <span><i class="fas fa-tachometer-alt"></i> <span id="connectedVehicleMileage">-</span> km</span>
                            <span><i class="fas fa-barcode"></i> <span id="connectedVehicleVIN">-</span></span>
                        </div>
                    </div>
                    <button id="changeVehicleBtn" class="btn btn-secondary btn-sm">
                        <i class="fas fa-exchange-alt"></i>
                        Cambiar
                    </button>
                </div>

                <!-- Botones de control de viaje -->
                <div class="trip-controls">
                    <button id="startTripBtn" class="btn btn-success btn-trip">
                        <i class="fas fa-play-circle"></i>
                        <div class="btn-trip-content">
                            <strong>Iniciar Viaje</strong>
                            <small>Comenzar grabación de datos OBD</small>
                        </div>
                    </button>

                    <button id="endTripBtn" class="btn btn-danger btn-trip" style="display: none;">
                        <i class="fas fa-stop-circle"></i>
                        <div class="btn-trip-content">
                            <strong>Finalizar Viaje</strong>
                            <small id="tripDurationDisplay">00:00:00</small>
                        </div>
                    </button>
                </div>

                <!-- Banner de viaje activo -->
                <div id="tripActiveBanner" class="trip-active-banner" style="display: none;">
                    <div class="recording-indicator">
                        <div class="recording-dot"></div>
                        <strong>VIAJE EN CURSO</strong>
                    </div>
                    <div class="trip-stats">
                        <div class="trip-stat">
                            <i class="fas fa-clock"></i>
                            <span id="activeTripDuration">00:00:00</span>
                        </div>
                        <div class="trip-stat">
                            <i class="fas fa-route"></i>
                            <span id="activeTripDistance">0.0 km</span>
                        </div>
                        <div class="trip-stat">
                            <i class="fas fa-database"></i>
                            <span id="activeTripDataPoints">0</span> registros
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Crear Nuevo Vehículo (cuando no está en lista) -->
        <div id="modalCreateVehicle" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-plus-circle"></i> Crear Nuevo Vehículo</h2>
                    <button class="modal-close" onclick="closeCreateVehicleModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="quickCreateVehicleForm">
                        <div class="form-group">
                            <label>Marca *</label>
                            <input type="text" id="quickVehicleBrand" required placeholder="Ej: Seat">
                        </div>

                        <div class="form-group">
                            <label>Modelo *</label>
                            <input type="text" id="quickVehicleModel" required placeholder="Ej: León 2.0 TDI">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Año *</label>
                                <input type="number" id="quickVehicleYear" required min="1990" max="2025" placeholder="2018">
                            </div>

                            <div class="form-group">
                                <label>Kilometraje</label>
                                <input type="number" id="quickVehicleMileage" placeholder="150000">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Combustible *</label>
                                <select id="quickVehicleFuel" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Diesel">Diesel</option>
                                    <option value="Gasolina">Gasolina</option>
                                    <option value="Híbrido">Híbrido</option>
                                    <option value="Eléctrico">Eléctrico</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Transmisión *</label>
                                <select id="quickVehicleTransmission" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Manual">Manual</option>
                                    <option value="Automático">Automático</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>VIN (opcional)</label>
                            <input type="text" id="quickVehicleVIN" placeholder="WVWZZZ1KZXW123456" maxlength="17">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateVehicleModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveQuickVehicle()">
                        <i class="fas fa-check"></i> Crear y Conectar
                    </button>
                </div>
            </div>
        </div>

        <!-- SECCIÓN 1: CONFIGURACIÓN DEL VEHÍCULO (OCULTO POR DEFECTO) -->
        <div class="card" id="vehicleConfigCard" style="display: none;">
            <h2>
                <i class="fas fa-cog"></i>
                Configuración del Vehículo
            </h2>
            <p class="text-muted">Esta sección solo se muestra cuando trabajas en modo "Nuevo Vehículo"</p>
            <div class="form-grid">
                <div class="form-group">
                    <label for="vehicleBrand"><i class="fas fa-car"></i> Marca</label>
                    <input type="text" id="vehicleBrand" placeholder="Ej: Seat">
                </div>
                <div class="form-group">
                    <label for="vehicleModel"><i class="fas fa-cogs"></i> Modelo y Motor</label>
                    <input type="text" id="vehicleModel" placeholder="Ej: León 2.0 TDI">
                </div>
                <div class="form-group">
                    <label for="vehicleYear"><i class="fas fa-calendar"></i> Año</label>
                    <input type="number" id="vehicleYear" placeholder="Ej: 2018" min="1996">
                </div>
                <div class="form-group">
                    <label for="vehicleMileage"><i class="fas fa-road"></i> Kilómetros</label>
                    <input type="number" id="vehicleMileage" placeholder="Ej: 95000">
                </div>
                <div class="form-group">
                    <label for="vehicleTransmission"><i class="fas fa-gears"></i> Transmisión</label>
                    <select id="vehicleTransmission">
                        <option value="manual">Manual</option>
                        <option value="automatica">Automática</option>
                        <option value="dsg">DSG/DCT</option>
                        <option value="cvt">CVT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vehicleType"><i class="fas fa-droplet"></i> Combustible</label>
                    <select id="vehicleType">
                        <option value="gasolina">Gasolina</option>
                        <option value="diesel">Diésel</option>
                        <option value="hibrido">Híbrido</option>
                        <option value="electrico">Eléctrico</option>
                    </select>
                </div>
            </div>

            <!-- Botón para guardar nuevo vehículo (solo visible en modo nuevo o import) -->
            <div id="saveNewVehicleSection" style="display: none; margin-top: 1.5rem;">
                <button id="saveNewVehicleBtn" class="btn btn-success btn-large">
                    <i class="fas fa-save"></i> Guardar Nuevo Vehículo
                </button>
                <p class="small-text" style="margin-top: 0.5rem; color: #64748b;">
                    <i class="fas fa-info-circle"></i> El vehículo se guardará en tu flota y quedará activo para el registro de datos.
                </p>
            </div>
        </div>

        <!-- SECCIÓN 2: SALUD DEL VEHÍCULO -->
        <div class="card health-card-main">
            <h2>
                <i class="fas fa-heartbeat"></i>
                Salud del Vehículo en Tiempo Real
            </h2>
            <div class="health-score-container">
                <div class="health-score-circle">
                    <span id="health_score" class="health-score-value excellent">100</span>
                    <span class="health-score-label">/100</span>
                </div>
                <div class="health-details-grid">
                    <div class="health-detail-item">
                        <i class="fas fa-engine"></i>
                        <span class="detail-label">Motor</span>
                        <span id="engine_health" class="detail-value">100</span>
                    </div>
                    <div class="health-detail-item">
                        <i class="fas fa-temperature-high"></i>
                        <span class="detail-label">Térmica</span>
                        <span id="thermal_health" class="detail-value">100</span>
                    </div>
                    <div class="health-detail-item">
                        <i class="fas fa-leaf"></i>
                        <span class="detail-label">Eficiencia</span>
                        <span id="efficiency_health" class="detail-value">100</span>
                    </div>
                </div>
            </div>
            
            <div id="warnings_container" class="warnings-container" style="display: none;"></div>
            <div id="predictions_container" class="predictions-container" style="display: none;"></div>
        </div>

        <!-- SECCIÓN 3: DATOS EN VIVO OPTIMIZADOS -->
        <div class="card">
            <h2>
                <i class="fas fa-tachometer-alt"></i>
                Datos en Vivo del Vehículo
                <span class="optimization-badge"><i class="fas fa-bolt"></i> Optimizado</span>
            </h2>
            
            <div class="data-section-header">
                <h3><i class="fas fa-stopwatch"></i> Datos Críticos (cada 3 segundos)</h3>
            </div>
            <div class="grid-stats">
                <div class="metric-box">
                    <div class="metric-label">
                        <i class="fas fa-cogs"></i> RPM Motor
                    </div>
                    <span class="metric-value" id="live_rpm">---</span>
                    <span class="metric-unit">rpm</span>
                </div>
                <div class="metric-box">
                    <div class="metric-label">
                        <i class="fas fa-road"></i> Velocidad
                    </div>
                    <span class="metric-value" id="live_speed">---</span>
                    <span class="metric-unit">km/h</span>
                </div>
                <div class="metric-box">
                    <div class="metric-label">
                        <i class="fas fa-route"></i> Distancia
                    </div>
                    <span class="metric-value" id="live_distance">---</span>
                    <span class="metric-unit">km</span>
                </div>
                <div class="metric-box">
                    <div class="metric-label">
                        <i class="fas fa-gas-pump"></i> Acelerador
                    </div>
                    <span class="metric-value" id="live_throttle">---</span>
                    <span class="metric-unit">%</span>
                </div>
                <div class="metric-box">
                    <div class="metric-label">
                        <i class="fas fa-weight-hanging"></i> Carga Motor
                    </div>
                    <span class="metric-value" id="live_load">---</span>
                    <span class="metric-unit">%</span>
                </div>
                <div class="metric-box">
                    <div class="metric-label">
                        <i class="fas fa-wind"></i> Flujo Aire (MAF)
                    </div>
                    <span class="metric-value" id="live_maf">---</span>
                    <span class="metric-unit">g/s</span>
                </div>
            </div>

            <div class="data-section-header thermal-section">
                <h3><i class="fas fa-clock"></i> Datos Térmicos (cada 60 segundos)</h3>
            </div>
            <div class="grid-stats thermal-grid">
                <div class="metric-box thermal">
                    <div class="metric-label">
                        <i class="fas fa-temperature-high"></i> Temp. Refrigerante
                    </div>
                    <span class="metric-value" id="live_coolant_temp">---</span>
                    <span class="metric-unit">°C</span>
                </div>
                <div class="metric-box thermal">
                    <div class="metric-label">
                        <i class="fas fa-temperature-low"></i> Temp. Admisión
                    </div>
                    <span class="metric-value" id="live_intake_temp">---</span>
                    <span class="metric-unit">°C</span>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                <button id="analyzeTripBtn" class="btn btn-ai btn-large" disabled>
                    <i class="fas fa-brain"></i>
                    Analizar Viaje Actual
                </button>
                <button id="downloadReportBtn" class="btn btn-primary">
                    <i class="fas fa-file-pdf"></i>
                    Descargar Informe
                </button>
                <button id="downloadCSVBtn" class="btn btn-primary">
                    <i class="fas fa-file-csv"></i>
                    Descargar CSV
                </button>
            </div>
            <small class="text-muted" style="display: block; margin-top: 0.5rem; color: #64748b;">
                <i class="fas fa-info-circle"></i> El análisis del viaje estará disponible después de 5 minutos de conducción
            </small>
        </div>

        <!-- SECCIÓN 4: RESULTADOS DEL ANÁLISIS VIAJE ACTUAL -->
        <div id="ai-placeholder" class="card" style="text-align: center; padding: 3rem;">
            <i class="fas fa-brain" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem; display: block;"></i>
            <h3 style="color: #94a3b8; margin: 0;">Analiza tu conducción en tiempo real</h3>
            <p style="color: #cbd5e1; margin-top: 0.5rem;">Inicia un viaje y conduce al menos 5 minutos para recibir análisis IA de tu estilo de conducción</p>
        </div>

        <div id="ai-results" style="display: none;"></div>

        <!-- SECCIÓN 5: MÓDULOS DE INTELIGENCIA -->
        <div class="grid-2">
            <div class="card">
                <h2>
                    <i class="fas fa-search"></i>
                    Análisis de Averías
                </h2>
                <p>Descubre las averías más comunes reportadas para tu modelo específico y cómo prevenirlas.</p>
                <button id="commonFailuresBtn" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fas fa-stethoscope"></i>
                    Analizar Averías
                </button>
                <div id="common-failures-result" style="margin-top: 1rem;"></div>
            </div>

            <div class="card">
                <h2>
                    <i class="fas fa-euro-sign"></i>
                    Tasación Inteligente
                </h2>
                <p>Obtén una valoración de mercado ajustada por el trato y mantenimiento que ha recibido tu vehículo.</p>
                <button id="valuationBtn" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fas fa-calculator"></i>
                    Calcular Valor
                </button>
                <div id="valuation-result" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- SECCIÓN 6: GESTIÓN DE ARCHIVOS CSV -->
        <div class="card">
            <h2>
                <i class="fas fa-database"></i>
                Gestión de Archivos CSV
            </h2>
            <p>Sube archivos CSV de viajes previos para análisis histórico y comparativo.</p>
            
            <div style="margin: 1.5rem 0;">
                <input type="file" id="uploadCSVInput" accept=".csv" style="display: none;">
                <button id="uploadCSVBtn" class="btn btn-primary">
                    <i class="fas fa-file-upload"></i>
                    Subir Archivo CSV
                </button>
            </div>

            <div id="csvFilesList" style="margin: 1.5rem 0;">
                <p class="no-data">Cargando archivos...</p>
            </div>
        </div>

        <!-- SECCIÓN 7: MANTENIMIENTO -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">
                    <i class="fas fa-wrench"></i>
                    Historial de Mantenimiento
                </h2>
                <button id="toggleMaintenanceFormBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-plus"></i>
                    Agregar
                </button>
            </div>

            <!-- FORMULARIO DE REGISTRO (Oculto por defecto) -->
            <div id="maintenanceFormContainer" style="display: none; margin-bottom: 1.5rem; padding: 1.5rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1e293b; font-size: 1rem;">
                    <i class="fas fa-plus-circle"></i> Nuevo Registro
                </h3>
                <form id="maintenanceForm">
                    <div class="form-group">
                        <label for="maintenanceType">Tipo de Intervención</label>
                        <input type="text" id="maintenanceType" placeholder="Ej: Cambio de aceite, Revisión de frenos" required>
                    </div>
                    <div class="form-group">
                        <label for="maintenanceDate">Fecha</label>
                        <input type="date" id="maintenanceDate" required>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            Guardar
                        </button>
                        <button type="button" id="cancelMaintenanceBtn" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- LISTA DE REGISTROS -->
            <ul id="maintenanceLog" style="list-style: none; margin: 0; padding: 0;">
                <li class="no-data">No hay registros de mantenimiento</li>
            </ul>
        </div>

    </div>

    <!-- FOOTER -->
    <footer>
        <p>SENTINEL PRO v9.0 - Sistema de Mantenimiento Predictivo © 2025</p>
        <p style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">
            Optimizado: Datos críticos cada 3s | Datos térmicos cada 60s | Análisis predictivo con IA
        </p>
    </footer>

    <script src="js/common.js"></script>
    <script src="js/script.js"></script>
</body>
</html>