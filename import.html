<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL PRO - Importar Datos CSV</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fleet.css">

    <style>
        .import-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Wizard Steps */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3rem;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e2e8f0;
            z-index: 0;
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #e2e8f0;
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: #94a3b8;
            transition: all 0.3s;
        }

        .wizard-step.active .step-circle {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }

        .wizard-step.completed .step-circle {
            background: #10b981;
            border-color: #10b981;
            color: #fff;
        }

        .step-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .wizard-step.active .step-label {
            color: #1e293b;
            font-weight: 600;
        }

        /* Step Content */
        .step-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Drag & Drop Zone */
        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s;
            cursor: pointer;
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .drop-zone i {
            font-size: 4rem;
            color: #3b82f6;
            margin-bottom: 1rem;
        }

        .drop-zone h3 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
        }

        .drop-zone p {
            margin: 0;
            color: #64748b;
        }

        /* File List */
        .file-list {
            margin-top: 2rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .file-item i {
            font-size: 1.5rem;
            color: #10b981;
        }

        .file-item-info {
            flex: 1;
        }

        .file-item-info strong {
            display: block;
            color: #1e293b;
        }

        .file-item-info span {
            font-size: 0.85rem;
            color: #64748b;
        }

        /* Source Badge */
        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .source-badge.torque {
            background: #dbeafe;
            color: #1e40af;
        }

        .source-badge.obd11 {
            background: #d1fae5;
            color: #065f46;
        }

        .source-badge.carista {
            background: #fef3c7;
            color: #92400e;
        }

        .source-badge.vcds {
            background: #e0e7ff;
            color: #3730a3;
        }

        .source-badge.sentinel_pro {
            background: #ede9fe;
            color: #5b21b6;
        }

        .source-badge.generic {
            background: #f1f5f9;
            color: #475569;
        }

        /* Preview Table */
        .preview-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .preview-table th {
            background: #f1f5f9;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }

        .preview-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Mapping Table */
        .mapping-table {
            width: 100%;
            margin-top: 1rem;
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 200px 1fr 100px;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .mapping-row label {
            font-weight: 600;
            color: #1e293b;
        }

        .mapping-row select {
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .mapping-status {
            text-align: center;
            font-size: 1.2rem;
        }

        .mapping-status.ok { color: #10b981; }
        .mapping-status.warning { color: #f59e0b; }
        .mapping-status.error { color: #ef4444; }

        /* Summary Box */
        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .summary-box h3 {
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
        }

        .summary-item label {
            display: block;
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .summary-item strong {
            display: block;
            font-size: 1.25rem;
        }

        /* Progress Log */
        .progress-log {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            padding: 0.25rem 0;
            display: flex;
            align-items: start;
            gap: 0.5rem;
        }

        .log-entry.success { color: #10b981; }
        .log-entry.error { color: #ef4444; }
        .log-entry.warning { color: #f59e0b; }
        .log-entry.info { color: #3b82f6; }

        /* Navigation Buttons */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn-wizard {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-wizard:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-wizard.primary {
            background: #3b82f6;
            color: #fff;
        }

        .btn-wizard.primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-wizard.secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-wizard.secondary:hover:not(:disabled) {
            background: #e2e8f0;
        }

        /* Result Success */
        .result-success {
            text-align: center;
            padding: 3rem 2rem;
        }

        .result-success i {
            font-size: 5rem;
            color: #10b981;
            margin-bottom: 1rem;
        }

        .result-success h2 {
            color: #1e293b;
            margin: 0 0 1rem 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-box {
            background: #f8fafc;
            padding: 1.5rem 1rem;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .stat-box label {
            display: block;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .stat-box strong {
            display: block;
            font-size: 1.75rem;
            color: #1e293b;
        }

        @media (max-width: 768px) {
            .wizard-steps {
                flex-wrap: wrap;
            }

            .step-circle {
                width: 40px;
                height: 40px;
            }

            .step-label {
                font-size: 0.75rem;
            }

            .drop-zone {
                padding: 2rem 1rem;
            }

            .mapping-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <h1>
            <i class="fas fa-shield-halved"></i>
            SENTINEL PRO
        </h1>
        <p>Importar Datos CSV</p>
    </header>

    <!-- NAVBAR DE NAVEGACIÓN -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="fleet.html" class="nav-link">
                <i class="fas fa-cars"></i> Flotas
            </a>
            <a href="analytics.html" class="nav-link">
                <i class="fas fa-chart-line"></i> Analytics
            </a>
            <a href="vehicle-detail.html" class="nav-link" id="nav-vehicle-detail" style="display: none;">
                <i class="fas fa-car-side"></i> Vehículo
            </a>
            <a href="alerts.html" class="nav-link">
                <i class="fas fa-bell"></i> Alertas
            </a>
            <a href="import.html" class="nav-link" id="nav-import" style="display: none;">
                <i class="fas fa-file-import"></i> Importar CSV
            </a>
        </div>
    </nav>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="import-container">

        <!-- WIZARD STEPS -->
        <div class="wizard-steps">
            <div class="wizard-step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Subir Archivo</div>
            </div>
            <div class="wizard-step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Análisis</div>
            </div>
            <div class="wizard-step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Mapeo</div>
            </div>
            <div class="wizard-step" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Configuración</div>
            </div>
            <div class="wizard-step" data-step="5">
                <div class="step-circle">5</div>
                <div class="step-label">Importar</div>
            </div>
        </div>

        <!-- PASO 1: SUBIDA DE ARCHIVO -->
        <div class="card step-content active" id="step1">
            <h2><i class="fas fa-file-upload"></i> Subir Archivo CSV</h2>
            <p style="color: #64748b; margin-bottom: 2rem;">
                Soportamos archivos CSV de Torque Pro, OBD11, Carista, VCDS y otros formatos de diagnóstico automotriz.
            </p>

            <div class="drop-zone" id="dropZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Arrastra tu archivo CSV aquí</h3>
                <p>o haz clic para seleccionar un archivo</p>
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
            </div>

            <div class="file-list" id="fileList" style="display: none;">
                <h3>Archivo Seleccionado:</h3>
                <div id="fileItemContainer"></div>
            </div>
        </div>

        <!-- PASO 2: ANÁLISIS -->
        <div class="card step-content" id="step2">
            <h2><i class="fas fa-search"></i> Análisis del Archivo</h2>

            <div id="analysisLoading" style="text-align: center; padding: 3rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #3b82f6;"></i>
                <p style="margin-top: 1rem; color: #64748b;">Analizando archivo...</p>
            </div>

            <div id="analysisResult" style="display: none;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                    <span>Origen detectado:</span>
                    <span id="detectedSource" class="source-badge"></span>
                </div>

                <div class="stats-grid" style="margin: 2rem 0;">
                    <div class="stat-box">
                        <label>Total de Filas</label>
                        <strong id="totalRows">0</strong>
                    </div>
                    <div class="stat-box">
                        <label>Rango de Fechas</label>
                        <strong id="dateRange" style="font-size: 1.1rem;">-</strong>
                    </div>
                    <div class="stat-box">
                        <label>Columnas</label>
                        <strong id="totalColumns">0</strong>
                    </div>
                </div>

                <div id="warningsContainer" style="display: none; margin: 1.5rem 0; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px;">
                    <strong style="color: #92400e;"><i class="fas fa-exclamation-triangle"></i> Advertencias:</strong>
                    <ul id="warningsList" style="margin: 0.5rem 0 0 1.5rem; color: #92400e;"></ul>
                </div>

                <h3 style="margin: 2rem 0 1rem 0;">Vista Previa de Datos</h3>
                <div style="overflow-x: auto;">
                    <table class="preview-table" id="previewTable"></table>
                </div>
            </div>
        </div>

        <!-- PASO 3: MAPEO DE COLUMNAS -->
        <div class="card step-content" id="step3">
            <h2><i class="fas fa-random"></i> Mapeo de Columnas</h2>
            <p style="color: #64748b; margin-bottom: 2rem;">
                Verifica que las columnas del CSV estén correctamente mapeadas a los campos de SENTINEL PRO.
            </p>

            <div class="mapping-table" id="mappingTable"></div>

            <button class="btn btn-secondary" id="autoMapBtn" style="margin-top: 1rem;">
                <i class="fas fa-magic"></i>
                Aplicar Mapeo Automático
            </button>
        </div>

        <!-- PASO 4: CONFIGURACIÓN -->
        <div class="card step-content" id="step4">
            <h2><i class="fas fa-cog"></i> Configuración de Importación</h2>

            <div style="margin: 2rem 0;">
                <h3>Vehículo Destino</h3>
                <div style="display: flex; gap: 2rem; margin: 1rem 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="vehicleOption" value="existing" checked>
                        <span>Importar a vehículo existente</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="vehicleOption" value="new">
                        <span>Crear nuevo vehículo</span>
                    </label>
                </div>

                <div id="existingVehicleSection">
                    <label>Seleccionar Vehículo:</label>
                    <select id="vehicleSelect" class="form-control" style="margin-top: 0.5rem;">
                        <option value="">Cargando vehículos...</option>
                    </select>
                </div>

                <div id="newVehicleSection" style="display: none; margin-top: 1rem;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>VIN</label>
                            <input type="text" id="newVehicleVin" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Marca</label>
                            <input type="text" id="newVehicleBrand" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Modelo</label>
                            <input type="text" id="newVehicleModel" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Año</label>
                            <input type="number" id="newVehicleYear" class="form-control" value="2020">
                        </div>
                        <div class="form-group">
                            <label>Combustible</label>
                            <select id="newVehicleFuel" class="form-control">
                                <option value="gasolina">Gasolina</option>
                                <option value="diesel">Diesel</option>
                                <option value="hibrido">Híbrido</option>
                                <option value="electrico">Eléctrico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Transmisión</label>
                            <select id="newVehicleTransmission" class="form-control">
                                <option value="manual">Manual</option>
                                <option value="automatica">Automática</option>
                                <option value="dsg">DSG/DCT</option>
                                <option value="cvt">CVT</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin: 2rem 0;">
                <h3>Opciones Avanzadas</h3>
                <div style="margin: 1rem 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 1rem;">
                        <input type="checkbox" id="createTripsCheck" checked>
                        <span>Crear viajes automáticamente</span>
                    </label>
                    <div id="tripGapSection" style="margin-left: 2rem;">
                        <label>Gap de inactividad (minutos): </label>
                        <input type="number" id="tripGapMinutes" value="30" min="5" max="180" style="width: 100px; padding: 0.25rem;">
                    </div>
                </div>

                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="skipInvalidCheck" checked>
                    <span>Omitir filas inválidas</span>
                </label>
            </div>

            <div class="summary-box" id="importSummary">
                <h3><i class="fas fa-clipboard-list"></i> Resumen de Importación</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <label>Archivo:</label>
                        <strong id="summaryFilename">-</strong>
                    </div>
                    <div class="summary-item">
                        <label>Origen:</label>
                        <strong id="summarySource">-</strong>
                    </div>
                    <div class="summary-item">
                        <label>Filas:</label>
                        <strong id="summaryRows">0</strong>
                    </div>
                    <div class="summary-item">
                        <label>Vehículo:</label>
                        <strong id="summaryVehicle">-</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- PASO 5: PROGRESO E IMPORTACIÓN -->
        <div class="card step-content" id="step5">
            <div id="importProgress">
                <h2><i class="fas fa-spinner fa-spin"></i> Importando Datos...</h2>
                <div style="margin: 2rem 0;">
                    <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="progressBar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="progressText" style="text-align: center; margin-top: 0.5rem; color: #64748b;">Preparando...</p>
                </div>

                <div class="progress-log" id="progressLog"></div>
            </div>

            <div id="importResult" style="display: none;">
                <div class="result-success">
                    <i class="fas fa-check-circle"></i>
                    <h2>¡Importación Exitosa!</h2>
                    <p style="color: #64748b;">Los datos han sido importados y el vehículo está listo para análisis</p>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <label>Filas Procesadas</label>
                            <strong id="resultRowsProcessed">0</strong>
                        </div>
                        <div class="stat-box">
                            <label>Filas Importadas</label>
                            <strong id="resultRowsImported">0</strong>
                        </div>
                        <div class="stat-box">
                            <label>Viajes Creados</label>
                            <strong id="resultTripsCreated">0</strong>
                        </div>
                        <div class="stat-box">
                            <label>Filas Omitidas</label>
                            <strong id="resultRowsSkipped">0</strong>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                        <a href="analytics.html" class="btn btn-primary">
                            <i class="fas fa-chart-line"></i>
                            Ver Analytics
                        </a>
                        <a href="fleet.html" class="btn btn-primary">
                            <i class="fas fa-cars"></i>
                            Ver Flotas
                        </a>
                        <button id="importMoreBtn" class="btn btn-secondary">
                            <i class="fas fa-plus"></i>
                            Importar Más
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NAVEGACIÓN -->
        <div class="wizard-nav">
            <button class="btn-wizard secondary" id="prevBtn" style="visibility: hidden;">
                <i class="fas fa-arrow-left"></i>
                Anterior
            </button>
            <button class="btn-wizard primary" id="nextBtn">
                Siguiente
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>

    </div>

    <script src="js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[IMPORT] Sistema de importación iniciado');

            let currentStep = 1;
            let uploadedFile = null;
            let analysisData = null;
            let columnMappings = {};

            const API_URL = 'http://localhost:5000';

            // === NAVEGACIÓN DEL WIZARD ===

            function goToStep(step) {
                // Ocultar todos los pasos
                document.querySelectorAll('.step-content').forEach(el => {
                    el.classList.remove('active');
                });

                // Mostrar paso actual
                document.getElementById(`step${step}`).classList.add('active');

                // Actualizar indicadores
                document.querySelectorAll('.wizard-step').forEach((el, index) => {
                    el.classList.remove('active');
                    if (index + 1 < step) {
                        el.classList.add('completed');
                    } else if (index + 1 === step) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('completed');
                    }
                });

                // Actualizar botones de navegación
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');

                prevBtn.style.visibility = step === 1 ? 'hidden' : 'visible';

                if (step === 1) {
                    nextBtn.textContent = 'Analizar Archivo';
                    nextBtn.innerHTML = 'Analizar Archivo <i class="fas fa-arrow-right"></i>';
                    nextBtn.disabled = !uploadedFile;
                } else if (step === 4) {
                    nextBtn.innerHTML = 'Importar Ahora <i class="fas fa-file-import"></i>';
                    nextBtn.disabled = false;
                } else if (step === 5) {
                    nextBtn.style.visibility = 'hidden';
                } else {
                    nextBtn.innerHTML = 'Siguiente <i class="fas fa-arrow-right"></i>';
                    nextBtn.disabled = false;
                }

                currentStep = step;

                // Acciones específicas por paso
                if (step === 2) {
                    analyzeFile();
                } else if (step === 3) {
                    renderMappingTable();
                } else if (step === 4) {
                    loadVehicles();
                    updateSummary();
                } else if (step === 5) {
                    executeImport();
                }
            }

            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentStep < 5) {
                    goToStep(currentStep + 1);
                }
            });

            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentStep > 1) {
                    goToStep(currentStep - 1);
                }
            });

            // === PASO 1: SUBIDA DE ARCHIVO ===

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            function handleFile(file) {
                if (!file.name.endsWith('.csv')) {
                    SENTINEL.Toast.error('Por favor selecciona un archivo CSV');
                    return;
                }

                uploadedFile = file;

                // Mostrar archivo en lista
                document.getElementById('fileList').style.display = 'block';
                document.getElementById('fileItemContainer').innerHTML = `
                    <div class="file-item">
                        <i class="fas fa-file-csv"></i>
                        <div class="file-item-info">
                            <strong>${file.name}</strong>
                            <span>${(file.size / 1024).toFixed(2)} KB</span>
                        </div>
                    </div>
                `;

                // Habilitar botón siguiente
                document.getElementById('nextBtn').disabled = false;
            }

            // === PASO 2: ANÁLISIS ===

            async function analyzeFile() {
                if (!uploadedFile) return;

                document.getElementById('analysisLoading').style.display = 'block';
                document.getElementById('analysisResult').style.display = 'none';

                try {
                    const formData = new FormData();
                    formData.append('file', uploadedFile);

                    const response = await fetch(`${API_URL}/api/import/analyze`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Error analizando archivo');
                    }

                    analysisData = await response.json();

                    // Mostrar resultados
                    document.getElementById('analysisLoading').style.display = 'none';
                    document.getElementById('analysisResult').style.display = 'block';

                    // Badge de origen
                    const sourceBadge = document.getElementById('detectedSource');
                    sourceBadge.className = `source-badge ${analysisData.source_detected}`;
                    sourceBadge.innerHTML = `
                        <i class="fas fa-microchip"></i>
                        ${analysisData.source_name}
                    `;

                    // Estadísticas
                    document.getElementById('totalRows').textContent = analysisData.total_rows;
                    document.getElementById('totalColumns').textContent = analysisData.columns_found.length;

                    if (analysisData.date_range && analysisData.date_range.start) {
                        document.getElementById('dateRange').textContent =
                            `${analysisData.date_range.start} - ${analysisData.date_range.end}`;
                    } else {
                        document.getElementById('dateRange').textContent = 'No detectado';
                    }

                    // Warnings
                    if (analysisData.warnings && analysisData.warnings.length > 0) {
                        document.getElementById('warningsContainer').style.display = 'block';
                        document.getElementById('warningsList').innerHTML =
                            analysisData.warnings.map(w => `<li>${w}</li>`).join('');
                    }

                    // Preview
                    renderPreviewTable();

                    // Guardar mappings
                    columnMappings = analysisData.mappings || {};

                } catch (error) {
                    console.error('[IMPORT] Error:', error);
                    SENTINEL.Toast.error('Error analizando archivo');
                }
            }

            function renderPreviewTable() {
                const table = document.getElementById('previewTable');
                const preview = analysisData.preview_data || [];

                if (preview.length === 0) {
                    table.innerHTML = '<tr><td colspan="100%">No hay datos para mostrar</td></tr>';
                    return;
                }

                const headers = Object.keys(preview[0]);

                // Headers
                const headerRow = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

                // Rows
                const rows = preview.slice(0, 10).map(row => {
                    return '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>';
                }).join('');

                table.innerHTML = headerRow + rows;
            }

            // === PASO 3: MAPEO ===

            function renderMappingTable() {
                const container = document.getElementById('mappingTable');
                const columns = analysisData.columns_found || [];

                const fields = [
                    { key: 'timestamp', label: 'Timestamp', required: true },
                    { key: 'rpm', label: 'RPM', required: true },
                    { key: 'speed', label: 'Velocidad', required: true },
                    { key: 'coolant_temp', label: 'Temp. Refrigerante', required: false },
                    { key: 'intake_temp', label: 'Temp. Admisión', required: false },
                    { key: 'maf', label: 'MAF', required: false },
                    { key: 'engine_load', label: 'Carga Motor', required: false },
                    { key: 'throttle_pos', label: 'Posición Acelerador', required: false },
                    { key: 'latitude', label: 'Latitud', required: false },
                    { key: 'longitude', label: 'Longitud', required: false }
                ];

                const html = fields.map(field => {
                    const currentMapping = columnMappings[field.key] || '';
                    const hasMapping = currentMapping !== '';
                    const status = hasMapping ? 'ok' : (field.required ? 'error' : 'warning');
                    const icon = hasMapping ? '✅' : (field.required ? '❌' : '⚠️');

                    return `
                        <div class="mapping-row">
                            <label>${field.label}</label>
                            <select class="mapping-select" data-field="${field.key}">
                                <option value="">-- Sin mapear --</option>
                                ${columns.map(col => `
                                    <option value="${col}" ${col === currentMapping ? 'selected' : ''}>
                                        ${col}
                                    </option>
                                `).join('')}
                            </select>
                            <span class="mapping-status ${status}">${icon}</span>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;

                // Event listeners
                document.querySelectorAll('.mapping-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const field = e.target.dataset.field;
                        columnMappings[field] = e.target.value;
                    });
                });
            }

            document.getElementById('autoMapBtn').addEventListener('click', () => {
                columnMappings = analysisData.mappings || {};
                renderMappingTable();
                SENTINEL.Toast.success('Mapeo automático aplicado');
            });

            // === PASO 4: CONFIGURACIÓN ===

            async function loadVehicles() {
                try {
                    const data = await SENTINEL.API.get('/api/vehicles');
                    const select = document.getElementById('vehicleSelect');

                    if (data.success && data.vehicles) {
                        select.innerHTML = '<option value="">Seleccionar vehículo...</option>';
                        data.vehicles.forEach(v => {
                            select.innerHTML += `<option value="${v.id}">${v.brand} ${v.model} (${v.year})</option>`;
                        });
                    }
                } catch (error) {
                    console.error('[IMPORT] Error cargando vehículos:', error);
                }
            }

            document.querySelectorAll('input[name="vehicleOption"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isNew = e.target.value === 'new';
                    document.getElementById('existingVehicleSection').style.display = isNew ? 'none' : 'block';
                    document.getElementById('newVehicleSection').style.display = isNew ? 'block' : 'none';
                    updateSummary();
                });
            });

            document.getElementById('vehicleSelect').addEventListener('change', updateSummary);
            document.getElementById('createTripsCheck').addEventListener('change', (e) => {
                document.getElementById('tripGapSection').style.display = e.target.checked ? 'block' : 'none';
            });

            function updateSummary() {
                document.getElementById('summaryFilename').textContent = uploadedFile ? uploadedFile.name : '-';
                document.getElementById('summarySource').textContent = analysisData ? analysisData.source_name : '-';
                document.getElementById('summaryRows').textContent = analysisData ? analysisData.total_rows : '0';

                const vehicleOption = document.querySelector('input[name="vehicleOption"]:checked').value;
                if (vehicleOption === 'existing') {
                    const select = document.getElementById('vehicleSelect');
                    const selectedOption = select.options[select.selectedIndex];
                    document.getElementById('summaryVehicle').textContent = selectedOption.text;
                } else {
                    const brand = document.getElementById('newVehicleBrand').value || 'Nuevo';
                    const model = document.getElementById('newVehicleModel').value || 'Vehículo';
                    document.getElementById('summaryVehicle').textContent = `${brand} ${model}`;
                }
            }

            // === PASO 5: IMPORTACIÓN ===

            async function executeImport() {
                const log = document.getElementById('progressLog');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');

                function addLog(message, type = 'info') {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${type}`;

                    const icon = {
                        'success': '✓',
                        'error': '✗',
                        'warning': '⚠',
                        'info': 'ℹ'
                    }[type] || 'ℹ';

                    entry.innerHTML = `<span>${icon}</span><span>${message}</span>`;
                    log.appendChild(entry);
                    log.scrollTop = log.scrollHeight;
                }

                try {
                    addLog('Validando datos...', 'info');
                    progressBar.style.width = '10%';
                    progressText.textContent = 'Validando...';

                    const vehicleOption = document.querySelector('input[name="vehicleOption"]:checked').value;
                    let vehicle_id = null;
                    let vehicle_data = null;

                    if (vehicleOption === 'existing') {
                        vehicle_id = parseInt(document.getElementById('vehicleSelect').value);
                        if (!vehicle_id) {
                            throw new Error('Selecciona un vehículo');
                        }
                    } else {
                        vehicle_data = {
                            vin: document.getElementById('newVehicleVin').value,
                            brand: document.getElementById('newVehicleBrand').value,
                            model: document.getElementById('newVehicleModel').value,
                            year: parseInt(document.getElementById('newVehicleYear').value),
                            fuel_type: document.getElementById('newVehicleFuel').value,
                            transmission: document.getElementById('newVehicleTransmission').value
                        };
                    }

                    addLog('Preparando importación...', 'info');
                    progressBar.style.width = '30%';
                    progressText.textContent = 'Preparando...';

                    const importConfig = {
                        temp_file: analysisData.temp_file,
                        vehicle_id: vehicle_id,
                        vehicle_data: vehicle_data,
                        source_type: analysisData.source_detected,
                        column_mappings: columnMappings,
                        create_trips: document.getElementById('createTripsCheck').checked,
                        trip_gap_minutes: parseInt(document.getElementById('tripGapMinutes').value),
                        skip_invalid_rows: document.getElementById('skipInvalidCheck').checked
                    };

                    addLog('Ejecutando importación...', 'info');
                    progressBar.style.width = '50%';
                    progressText.textContent = 'Importando datos...';

                    const response = await fetch(`${API_URL}/api/import/execute`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(importConfig)
                    });

                    if (!response.ok) {
                        throw new Error('Error ejecutando importación');
                    }

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'Error desconocido');
                    }

                    progressBar.style.width = '90%';
                    progressText.textContent = 'Finalizando...';

                    addLog(`✓ Filas importadas: ${result.rows_imported}`, 'success');
                    addLog(`✓ Viajes creados: ${result.trips_created}`, 'success');

                    if (result.rows_skipped > 0) {
                        addLog(`⚠ Filas omitidas: ${result.rows_skipped}`, 'warning');
                    }

                    if (result.errors && result.errors.length > 0) {
                        result.errors.slice(0, 5).forEach(err => {
                            addLog(err, 'warning');
                        });
                    }

                    progressBar.style.width = '100%';
                    progressText.textContent = '¡Completado!';

                    addLog('✅ IMPORTACIÓN COMPLETADA', 'success');

                    // FIX: Establecer vehículo como activo para que sea visible en analytics/fleet
                    const importedVehicleId = result.vehicle_id || vehicle_id;
                    if (importedVehicleId) {
                        SENTINEL.ActiveVehicle.set(parseInt(importedVehicleId));
                        addLog(`✓ Vehículo ID ${importedVehicleId} establecido como activo`, 'success');
                        console.log('[IMPORT] ✓ Vehículo establecido como activo:', importedVehicleId);
                    }

                    // Mostrar resultado
                    setTimeout(() => {
                        document.getElementById('importProgress').style.display = 'none';
                        document.getElementById('importResult').style.display = 'block';

                        document.getElementById('resultRowsProcessed').textContent = analysisData.total_rows;
                        document.getElementById('resultRowsImported').textContent = result.rows_imported;
                        document.getElementById('resultTripsCreated').textContent = result.trips_created;
                        document.getElementById('resultRowsSkipped').textContent = result.rows_skipped;
                    }, 1000);

                } catch (error) {
                    console.error('[IMPORT] Error:', error);
                    addLog(`✗ Error: ${error.message}`, 'error');
                    progressText.textContent = 'Error en la importación';
                    SENTINEL.Toast.error('Error en la importación');
                }
            }

            document.getElementById('importMoreBtn').addEventListener('click', () => {
                window.location.reload();
            });

            // Inicialización
            console.log('[IMPORT] ✓ Sistema listo');
        });
    </script>
</body>
</html>
